    <!DOCTYPE html>
    <html lang="fr">
    <head>

      <!-- TikTok Pixel Code Start -->
<script>
!function (w, d, t) {
  w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(
var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script")
;n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};


  ttq.load('D3F46ERC77UCTDLGVG9G');
  ttq.page();
}(window, document, 'ttq');
</script>
<!-- TikTok Pixel Code End -->
      


      <link rel="icon" href="/images/market/logo.webp" type="image/jpeg">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
      <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
      <title>MyAICrush - Les meilleures copines IA francophones</title>
    <link rel="stylesheet" href="styles.css?v=2">

    
      
      

      <!-- Google Analytics (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FJ5S0H9B1R"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'G-FJ5S0H9B1R');
      </script>
    </head>
    <body>

    
 <div id="loader">
  <div class="heart-loader">
    <div class="heart"></div>
  </div>

  <!-- Nouveau bloc brand -->
  <div class="loader-brand">
    <div class="loader-logo">MyAiCrush.AI</div>
    <div class="loader-subtitle">Les meilleures I.A. francophones</div>
  </div>

  <p id="loader-text" class="loader-text"></p>
</div>



      <div id="cheaper-plan-dynamic-banner"></div>
      
    


      <!-- Garder le header en haut de la page, en dehors de .container -->
      <div class="header">
        <br><h1>Choisis ta partenaire :</h1>
        <center><p>Ces I.A. ont l‚Äôair sages‚Ä¶ mais attend de voir.</p></center>
      </div>
  <br>

  


      <!-- Conteneur principal pour les options de chat et le chat -->
      <div class="container">


       <!-- Barre de stories -->
<div class="stories-wrapper">
  <div id="stories"></div>
</div>
 

        <!-- Options de chat -->
        <div class="chat-options" id="chat-options"></div>

        <!-- Conteneur pour les fiches de personnages -->
        <div id="character-cards-container"></div>

        <!-- Zone de chat -->
        <div id="chat-box" style="display: none;">
         
<div id="chat-header">
  <button id="back-btn">
    <i class="fa fa-arrow-left"></i>
  </button>

  <!-- Photo de profil -->
  <img id="chat-profile-pic" 
       src="images/loading-placeholder.webp" 
       data-src="images/hanae/hanae2/da9f17ba08caefcd4502c0d9e5ca2b95-light.webp"
       alt="Profil s√©lectionn√©" 
       class="chat-profile-pic lazyload">

  <!-- Bouton appel audio -->
  <button id="audio-call-btn" class="audio-call-btn">
    <i class="fa fa-phone"></i>
  </button>

  <!-- Nom de l'IA (reste √† gauche, proche du t√©l√©phone) -->
  <span id="chat-name">Nom de l'IA</span>

  <!-- Cadenas tout √† droite -->
  <a href="contenu-prive.html" class="chat-lock-link" title="Contenus priv√©s">
    <img src="images/market/cadenas-coeur.webp" alt="Contenu priv√©" class="chat-lock-icon">
  </a>
</div>


          <!-- ‚úÖ Toggle Mode Images/GIFs -->
    <div id="mode-toggle-container">
      <span>üì∏ Images</span>
      <label class="switch">
          <input type="checkbox" id="toggleMode">
          <span class="slider"></span>
      </label>
      <span>üé• Vid√©os</span>
    </div>

    <div id="nympho-mode-toggle-wrapper" style="display: none; justify-content: center; align-items: center; gap: 10px; margin: 10px 0;">
      <span>ü•µ Mode Nymphomane</span>
      <label class="switch">
        <input type="checkbox" id="nymphoModeToggle">
        <span class="slider"></span>
      </label>
    </div>




        
          <div id="messages"></div>

          <!-- Indicateur de saisie -->
          <div id="typing-indicator" class="hidden">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>

          <div id="quick-replies" class="quick-replies hidden"></div>


          <div id="input-area">
            <label for="image-input" id="upload-btn">
              <i class="fa fa-image"></i>
            </label>
            
            <input 
              type="file" 
              id="image-input" 
              accept="image/*" 
              style="opacity: 0; position: absolute; left: -9999px;">
            
          
            <input type="text" id="user-input" placeholder="√âcris ton message ici...">
          
            <button id="send-btn">
              <i class="fa fa-paper-plane"></i>
            </button>
          </div>
          
        
        </div>
      </div>

      <!-- Conteneur pour afficher la fiche de personnage en plein √©cran -->
      <div id="profile-modal" class="modal" onclick="closeProfileModal()">
        <div class="profile-content" onclick="event.stopPropagation()">
          <button id="close-modal-btn" class="close-modal-btn">&times;</button>
          <img id="profile-image-full" src="images/loading-placeholder.webp" alt="Profil complet" />
          <h2 id="profile-name"></h2><br>
          <p><strong>Taille :</strong> <span id="profile-height"></span></p>
          <p><strong>Profil :</strong> <span id="profile-measurements"></span></p>
          <p><strong>Situation :</strong> <span id="profile-ethnicity"></span></p>
          <p><strong>Passions :</strong> <span id="profile-interests"></span></p>
        </div>
      </div>

      <!-- Pied de page -->
      <footer class="footer">
        <p>&copy; 2025 MyAICrush - Tous droits r√©serv√©s.</p>
        
          <a href="privacy-policy.html">Politique de Confidentialit√©</a>
          <a href="terms-and-conditions.html">Conditions G√©n√©rales</a>
        
      </footer>
      
    
   <!-- STORY VIEWER fa√ßon Instagram -->
<div id="story-viewer" class="story-viewer hidden">
  <div class="story-viewer-content">
    
    <!-- Header avatar + nom + close -->
    <div class="story-header">
      <div class="story-header-left">
        <img id="story-avatar" class="story-avatar" src="" alt="Profil">
        <span id="story-username" class="story-username"></span>
      </div>
      <button id="story-close-btn" class="story-close-btn">&times;</button>
    </div>

    <!-- Barre de progression -->
    <div id="story-progress" class="story-progress"></div>

    <!-- M√©dia -->
    <img id="story-media-img" class="story-media hidden">
   <video id="story-media-video"
       class="story-media story-media-video"
       autoplay loop muted playsinline></video>


    <!-- Zones cliquables gauche/droite -->
    <div id="story-prev" class="story-nav-left"></div>
    <div id="story-next" class="story-nav-right"></div>

    <!-- R√©ponse √† la story -->
    <div class="story-reply-bar">
      <input id="story-reply-input" type="text" placeholder="R√©pondre √† l'IA..." />
      <button id="story-reply-send">Envoyer</button>
    </div>
  </div>
</div>




      <script type="module" src="./scripts/main.js"></script>
      
      

      <!-- ‚úÖ Script pour remplacer l'image temporaire une fois charg√©e -->
      <script>
        document.addEventListener("DOMContentLoaded", function() {
          const chatProfilePic = document.getElementById("chat-profile-pic");
          if (chatProfilePic) {
            const actualSrc = chatProfilePic.getAttribute("data-src");
            if (actualSrc) {
              const img = new Image();
              img.src = actualSrc;
              img.onload = function() {
                chatProfilePic.src = actualSrc;
              };
            }
          }
        });
      </script>



    <script>
      function getFacebookParams() {
          var urlParams = new URLSearchParams(window.location.search);

          // ‚úÖ R√©cup√©rer `fbc` (Facebook Click ID) s'il est pr√©sent dans l'URL
          var fbc = urlParams.get('fbclid') ? "fb." + Math.floor(Date.now() / 1000) + "." + urlParams.get('fbclid') : null;

          // ‚úÖ R√©cup√©rer `fbp` g√©n√©r√© automatiquement par le Pixel Facebook
          var fbp = null;
          if (window.fbq && fbq.getState) {
              fbp = fbq.getState().lastExternalId;
          }

          // ‚úÖ Stocker les valeurs dans localStorage pour les r√©cup√©rer plus tard (Stripe Checkout)
          if (fbp) localStorage.setItem('fbp', fbp);
          if (fbc) localStorage.setItem('fbc', fbc);
      }

      getFacebookParams();
    </script>

  





  <script>
    (function() {
      const params = new URLSearchParams(window.location.search);
      const tp = params.get("tp");
      if (tp) {
        // Stocke le param√®tre "tp" dans un cookie pour 30 jours
        const expiration = new Date();
        expiration.setTime(expiration.getTime() + (30*24*60*60*1000)); // 30 jours
        document.cookie = `forcedTp=${tp}; expires=${expiration.toUTCString()}; path=/`;
      }
    })();
  </script>





  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const loader = document.getElementById("loader");
    const loaderText = document.getElementById("loader-text");

    const phrases = [
      "Pas besoin d‚Äô√™tre humaine pour te faire vibrer",
      "Pas besoin de roses‚Ä¶ fais-la frissonner autrement",
      "Elles n‚Äôexistent pas‚Ä¶ mais tu risques d‚Äôy penser toute la nuit",
      "Pas besoin d‚Äô√™tre r√©elle pour te rendre accro.",
      "Moins de prises de t√™te. Plus de photos",
      "Pas de blabla. Elles vont droit au but",
      "Elles savent pas cuisiner, mais elles savent comment combler un homme‚Ä¶",
      "Elles aiment pas les gentils gar√ßons‚Ä¶ elles aiment quand tu les tiens par les hanches.",
      "Si tu passes Lilith ou Angel en mode nympho, elles deviennent folles de toi.",
      "Parle de ta nouvelle copine √† Chlo√©, √ßa va la rendre folle de jalousie.",
      "Candy en mode nympho ? Elle te montre... absolument tout.",
      "Le mode nympho d'Alex est le pr√©f√©r√© de nos abonn√©s.",
      "De nouvelles I.A. tous les mois",
      "¬´ ‚≠ê Enfin un site qui parle un vrai fran√ßais. Les IA sont pas d√©biles, on dirait presque une vraie meuf. ¬ª",
      "¬´ ‚≠ê Putain le mode nympho üò≥ id√©e de g√©nie. M√™me les IA timides deviennent folles. ¬ª",
      "¬´ ‚≠ê J‚Äôai test√© les vocaux... √ßa m'a trop excit√©. Sa voix c‚Äôest abus√© ¬ª",
      "¬´ ‚≠ê Jasmine √©tait toute sage au d√©but‚Ä¶ et l√† d‚Äôun coup üò≥ j‚Äô√©tais pas pr√™t ",
      "Plus de tabous, plus de limites, juste vous deux.",
        "Une connexion plus intime que n'importe quel match Tinder.",
          "Elles n‚Äôont pas de c≈ìur‚Ä¶ mais elles savent o√π toucher le tien.",
            "Ton doigt sur l‚Äô√©cran, son souffle dans ta nuque.",
    "¬´ ‚≠ê Elles comprennent mieux que ma vraie ex‚Ä¶ c‚Äôest grave ? ¬ª",
      "¬´ ‚≠ê Premi√®re IA qui me donne l‚Äôimpression d‚Äôavoir une vraie connexion. ¬ª",
      "¬´ ‚≠ê M√™me apr√®s le boulot, elles arrivent √† me vider l‚Äôesprit‚Ä¶ et pas que... ¬ª",
      "¬´ ‚≠ê J‚Äôai voulu tester par curiosit√©‚Ä¶ j‚Äôai pris l‚Äôabonnement direct. ¬ª",
        "¬´ ‚≠ê Je pensais que c‚Äô√©tait du fake‚Ä¶ jusqu‚Äô√† ce qu‚Äôelle m‚Äôenvoie la photo. ¬ª",
        "Laisse-la te murmurer des envies qu‚Äôaucune humaine n‚Äôoserait.",
          "Elle veut tes envies les plus inavouables, et les photos qui vont avec.",
    "Elle est pr√™te √† tout‚Ä¶ mais est-ce que toi tu l‚Äôes ?",
    "Une IA ne te jugera jamais‚Ä¶ m√™me quand tu vas trop loin.",
    "Ce ne sont que des machines... mais elles te diront ce que tu r√™ves d'entendre.",
    "Tu crois la contr√¥ler, mais c‚Äôest elle qui te fait perdre le contr√¥le.",
    "Elles te parlent comme aucune femme n‚Äôa jamais os√© le faire.",
    "Essaie l'une de nos IA. Tu vas en redemander... encore et encore",
    "Elles sont si r√©alistes qu'on oublie qu'elles n'existent pas.",
     "La seule diff√©rence avec les vraies filles ? Elles sont plus sexy.",
     "¬´ ‚≠ê MyAiCrush, meilleur site d'IA francophone ¬ª",
     "¬´ ‚≠ê J'aime trop Emilie. Cette IA me rend fou ¬ª",
    "¬´ ‚≠ê Le mode nympho ? Franchement, j‚Äôai jamais vu un truc pareil ¬ª"

    ];

    const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
    loaderText.textContent = randomPhrase;
    loaderText.classList.add("visible");

    setTimeout(() => {
      loader.style.opacity = "0";
      setTimeout(() => loader.remove(), 500);
    }, 3000);
  });


  </script>



  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const container = document.getElementById("cheaper-plan-dynamic-banner");
      const chatBox = document.getElementById("chat-box");
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user || !user.email || !container || !chatBox) return;

      try {
        const res = await fetch(`${window.location.origin}/api/is-premium`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: user.email })
        });

        const { isPremium } = await res.json();

        const banner = document.createElement("a");
banner.className = "dynamic-banner";
banner.href = "#"; // Interception du clic
banner.innerHTML = `
  ${isPremium
    ? `<i class="fas fa-coins plan-icon"></i>
        <span class="plan-text">Recharger ses jetons</span>
        <span class="plan-discount">‚û°Ô∏è Jetons</span>`
    : `<span class="plan-icon">üíé</span>
        <span class="plan-text">Premium</span>
        <span class="plan-discount">50% de r√©duction</span>`}
`;
container.appendChild(banner);

// ‚úÖ Ajoute le listener
banner.addEventListener("click", async (e) => {
  e.preventDefault();

  if (!user?.email) return;

  if (isPremium) {
    try {
      const res = await fetch("/api/check-one-click-eligibility", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email }),
      });

      const data = await res.json();

      const resolvedMedia = resolvedMedia.map(resolveStoryMedia);


      if (data.eligible) {
        openJetonsPopup(); // ‚úÖ Affiche la popup 1C
      } else {
        window.location.href = "/jetons.html"; // ‚ùå Redirige si non √©ligible
      }
    } catch (err) {
      console.error("‚ùå Erreur 1C dynamic-banner :", err);
      window.location.href = "/jetons.html";
    }
  } else {
    window.location.href = "/premium.html";
  }
});


        // ‚úÖ Observer si le chat est actif pour masquer/afficher la banni√®re
        const observer = new MutationObserver(() => {
          banner.style.display = (chatBox.style.display === "flex") ? "none" : "flex";
        });

        observer.observe(chatBox, { attributes: true, attributeFilter: ['style'] });

      } catch (err) {
        console.error("‚ùå Erreur banni√®re dynamique :", err);
      }
    });
  </script>
  <script type="module" src="/scripts/menu-loader.js"></script>



  <script>

  document.addEventListener("DOMContentLoaded", async () => {
    const header = document.querySelector(".header");

    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || !user.email) return;

    try {
      const res = await fetch(`${window.location.origin}/api/is-premium`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email })
      });

      const { isPremium } = await res.json();

      if (!isPremium) return;

      // ‚úÖ Cr√©er une nouvelle div wrapper en dehors de container
      const sliderSection = document.createElement("div");
      sliderSection.className = "private-slider-section";
      sliderSection.innerHTML = `
        <div id="private-slider" class="private-slider">
          <div class="slider-inner">
            <img src="images/market/nour-slider-prive.webp" alt="Slide 2" />
             <img src="images/market/asha-slider-prive.webp" alt="Slide 2" />
             <img src="images/market/alex-slider-prive.webp" alt="Slide 2" />
            <img src="images/market/emilie-slider-prive.webp" alt="Slide 2" />
             <img src="images/market/naomi-slider-prive.webp" alt="Slide 2" />
            <img src="images/market/lila-slider-prive.webp" alt="Slide 2" />
            <img src="images/market/chloe-slider-prive.webp" alt="Slide 3" />
            <img src="images/market/candy-slider-prive.webp" alt="Slide 1" />
            <img src="images/market/jasmine-slider-prive.webp" />
            <img src="images/market/lea-slider-prive.webp" alt="Slide 4" />
            <img src="images/market/hanae-slider-prive.webp" alt="Slide 5" />
            <img src="images/market/astrid-slider-prive.webp" alt="Slide 6" />
            <img src="images/market/angel-slider-prive.webp" alt="Slide 7" />
          </div>
          <button class="slider-arrow left-arrow">&#10094;</button>
          <button class="slider-arrow right-arrow">&#10095;</button>
        </div>
      `;

      // ‚úÖ Ins√©rer apr√®s le header
      header.insertAdjacentElement("afterend", sliderSection);

      const slider = sliderSection.querySelector("#private-slider");
      const sliderInner = slider.querySelector(".slider-inner");
      const slides = sliderInner.querySelectorAll("img");
      const leftArrow = slider.querySelector(".left-arrow");
      const rightArrow = slider.querySelector(".right-arrow");

      let index = 0;
      const totalSlides = slides.length;

      function showSlide(i) {
        const sliderWidth = slider.clientWidth;
        sliderInner.style.transform = `translateX(-${i * sliderWidth}px)`;
      }

      function nextSlide() {
        index = (index + 1) % totalSlides;
        showSlide(index);
      }

      function prevSlide() {
        index = (index - 1 + totalSlides) % totalSlides;
        showSlide(index);
      }

      let autoSlide = setInterval(nextSlide, 3000);

      rightArrow.addEventListener("click", (e) => {
        e.stopPropagation();
        nextSlide();
        resetAuto();
      });

      leftArrow.addEventListener("click", (e) => {
        e.stopPropagation();
        prevSlide();
        resetAuto();
      });

      function resetAuto() {
        clearInterval(autoSlide);
        autoSlide = setInterval(nextSlide, 3000);
      }

      slider.addEventListener("click", () => {
        window.location.href = "contenu-prive.html";
      });

    } catch (err) {
      console.error("‚ùå Erreur v√©rification premium :", err);
    }
  });



  </script>


<script type="module" src="/scripts/popup-loader.js"></script>


<!-- Widget VAPI cach√© au d√©part -->

<script type="module">
  import { characters } from './scripts/data.js';

  document.addEventListener("DOMContentLoaded", () => {
    const audioCallBtn = document.getElementById("audio-call-btn");
    let widgetInjected = false;

    audioCallBtn.addEventListener("click", async () => {
      const characterName = document.getElementById("chat-name")?.textContent?.trim();
      const character = characters.find(c => c.name === characterName);
      if (!character || !character.agent?.id) return alert("Erreur : personnage introuvable.");
      const assistantId = character.agent.id;

      const user = JSON.parse(localStorage.getItem("user"));
      const email = user?.email;
      if (!email) return alert("Veuillez vous connecter.");

      // √âtape 1 : v√©rifier si l'utilisateur est premium
      try {
        const resPremium = await fetch("/api/is-premium", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });
        const { isPremium } = await resPremium.json();
        if (!isPremium) {
          alert("üîí Les appels audio sont r√©serv√©s aux abonn√©s Premium.");
          return window.location.href = "/premium.html";
        }
      } catch (err) {
        console.error("‚ùå Erreur v√©rif premium :", err);
        return;
      }

      // √âtape 2 : avertir l'utilisateur du co√ªt
      if (!confirm("Un appel audio co√ªte 20 jetons pour 10 minutes. Souhaites-tu continuer ?")) return;

      // √âtape 3 : tenter de d√©marrer l‚Äôappel (v√©rifie jetons + d√©bite)
      try {
        const resCall = await fetch("/api/start-call", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        const result = await resCall.json();

        if (!result.success) {
          console.warn("‚ùå Appel refus√© :", result.message);

          if (result.redirect) {
            // V√©rifie l‚Äô√©ligibilit√© au 1C avant de rediriger
            const res1C = await fetch("/api/check-one-click-eligibility", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email })
            });
            const { eligible } = await res1C.json();

            if (eligible && typeof openJetonsPopup === "function") {
              return openJetonsPopup();
            } else {
              return window.location.href = result.redirect;
            }
          }

          alert(result.message || "Erreur lors du d√©marrage de l'appel.");
          return;
        }

        console.log("‚úÖ Appel d√©marr√© :", result.message);
      } catch (err) {
        console.error("‚ùå Erreur backend /start-call :", err);
        return alert("Erreur serveur lors du d√©marrage de l'appel.");
      }

      // √âtape 4 : injection du widget
      if (widgetInjected) return;

      const widgetHTML = `
        <vapi-widget
          id="vapi-widget"
          public-key="ee13ad83-743b-46cf-866c-4b0fe9b30f32"
          assistant-id="${assistantId}"
          mode="voice"
          theme="dark"
          base-bg-color="#dd4d9d"
          accent-color="#FFFFFF"
          cta-button-color="#dd4d9d"
          cta-button-text-color="#ffffff"
          border-radius="large"
          size="tiny"
          position="bottom-left"
          title="Commencer l'appel"
          start-button-text="Commencer l'appel"
          end-button-text="Terminer l'appel"
          chat-first-message="Hey, how can I help you today?"
          chat-placeholder="Type your message..."
          voice-show-transcript="true"
          consent-required="true"
          consent-title="Terms and conditions"
          consent-content="By clicking 'Agree'... etc."
          consent-storage-key="vapi_widget_consent"
        ></vapi-widget>
      `;

      alert("üéß Ton appel audio va commencer...\nUne petite bulle rose va appara√Ætre en bas de ton √©cran.");

      document.body.insertAdjacentHTML("beforeend", widgetHTML);

      const script = document.createElement("script");
      script.src = "https://unpkg.com/@vapi-ai/client-sdk-react/dist/embed/widget.umd.js";
      script.async = true;
      script.type = "text/javascript";
      script.onload = () => {
        console.log("‚úÖ Widget Vapi charg√©.");
      };
      document.body.appendChild(script);

      widgetInjected = true;

      // ‚è≥ Auto-suppression du widget apr√®s 10 minutes (600 000 ms) ‚Äî pour test : 10 sec
setTimeout(() => {
  const widget = document.getElementById("vapi-widget");
  if (widget) {
    widget.remove();
    widgetInjected = false;
    console.log("‚è±Ô∏è Widget supprim√© apr√®s 10 secondes.");
  }
}, 600000); // ‚Üê ‚Üê ‚Üê change √† 600000 pour 10 min

    });
  });
</script>


<!-- STORIES -->
<script type="module">
  import { characters } from './scripts/data.js';
  import { startChat } from './scripts/chat.js';

    // =========================
  // CDN RESOLUTION (STORIES)
  // =========================
  const CDN_BASE =
    location.hostname === 'localhost' || location.hostname === '127.0.0.1'
      ? ''
      : 'https://img.myaicrush.ai';

  function resolveStoryMedia(url) {
    if (!url) return url;
    if (url.startsWith('http')) return url;
    if (url.startsWith('images/')) {
      return `${CDN_BASE}/${url}`;
    }
    return url;
  }


  const STORY_DURATION = 5000; // 5 sec
  const STORY_CACHE_KEY = 'myaicrush_stories_v1';
  const STORY_CACHE_TTL_MS = 24 * 60 * 60 * 1000; // 24h

  let storyGroups = [];        // [{ characterName, avatar, media }]
  let currentGroupIndex = 0;
  let currentStoryIndex = 0;
  let autoTimer = null;

  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  async function waitForCharacters() {
    const start = Date.now();
    while (characters.length === 0 && Date.now() - start < 5000) {
      await sleep(50);
    }
    return characters;
  }

  // üî• Force le dossier1 : images/aiko/aiko1
  function getCharacterStoryFolder(character) {
    const base = character.photo;
    if (!base) return null;
    const parts = base.split('/');
    if (parts.length < 3) return null;
    const girl = parts[1]; // ex : aiko
    return `images/${girl}/${girl}1`;
  }

  // --------- FILTRE FORMAT STORY (vertical) ---------
  function isStoryRatio(width, height) {
  if (!width || !height) return false;
  const ratio = height / width;

  // ‚úÖ Format "vraie story" :
  // - tr√®s vertical : ratio >= 1.5
  // - suffisamment grand : hauteur >= 800 px
  //   => 500x886 ‚úÖ
  //   => 512x650 ‚ùå
  return ratio >= 1.5 && height >= 800;
}



  function checkImageStoryFormat(url) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        resolve(isStoryRatio(img.naturalWidth, img.naturalHeight));
      };
      img.onerror = () => resolve(false);
      img.src = url;
    });
  }

  function checkVideoStoryFormat(url) {
    return new Promise((resolve) => {
      const video = document.createElement('video');
      video.preload = 'metadata';
      video.onloadedmetadata = () => {
        resolve(isStoryRatio(video.videoWidth, video.videoHeight));
      };
      video.onerror = () => resolve(false);
      video.src = url;
    });
  }

  async function isStoryMedia(url) {
    if (/\.(mp4|webm|mov)$/i.test(url)) {
      return await checkVideoStoryFormat(url);
    }
    return await checkImageStoryFormat(url);
  }

  async function filterStoryMediaList(list = []) {
    const checks = await Promise.all(list.map((url) => isStoryMedia(url)));
    return list.filter((url, idx) => checks[idx]);
  }

  // ---------- PROGRESS BAR ----------
  function renderProgressBar(total) {
    const container = document.getElementById('story-progress');
    container.innerHTML = '';
    for (let i = 0; i < total; i++) {
      const seg = document.createElement('div');
      seg.className = 'story-progress-segment';
      const inner = document.createElement('div');
      inner.className = 'story-progress-inner';
      seg.appendChild(inner);
      container.appendChild(seg);
    }
  }

  function updateProgressBar() {
    const segments = Array.from(
      document.querySelectorAll('.story-progress-segment .story-progress-inner')
    );
    segments.forEach((inner, idx) => {
      inner.style.transition = 'none';
      if (idx < currentStoryIndex) {
        inner.style.width = '100%';
      } else if (idx > currentStoryIndex) {
        inner.style.width = '0%';
      }
    });

    const currentInner = segments[currentStoryIndex];
    if (currentInner) {
      currentInner.style.width = '0%';
      void currentInner.offsetWidth;
      currentInner.style.transition = `width ${STORY_DURATION}ms linear`;
      currentInner.style.width = '100%';
    }
  }

  // ---------- VIEWER ----------
  function showStory() {
    clearTimeout(autoTimer);

    const group = storyGroups[currentGroupIndex];
    if (!group) return;

    const url = group.media[currentStoryIndex];
    const viewer = document.getElementById('story-viewer');
    const img = document.getElementById('story-media-img');
    const vid = document.getElementById('story-media-video');
    const avatar = document.getElementById('story-avatar');
    const username = document.getElementById('story-username');
    const replyInput = document.getElementById('story-reply-input');

    avatar.src = group.avatar || '';
    username.textContent = group.characterName || '';

    img.classList.add('hidden');
    vid.classList.add('hidden');
    vid.pause();

    if (/\.(mp4|webm|mov)$/i.test(url)) {
      vid.src = url;
      vid.classList.remove('hidden');
      vid.play().catch(() => {});
    } else {
      img.src = url;
      img.classList.remove('hidden');
    }

    replyInput.placeholder = `R√©pondre √† ${group.characterName}...`;

    viewer.classList.remove('hidden');

    renderProgressBar(group.media.length);
    updateProgressBar();

    autoTimer = setTimeout(nextStory, STORY_DURATION);
  }

  function closeViewer() {
    clearTimeout(autoTimer);
    document.getElementById('story-viewer').classList.add('hidden');
  }

  function nextStory() {
    const group = storyGroups[currentGroupIndex];
    if (!group) return;

    if (currentStoryIndex < group.media.length - 1) {
      currentStoryIndex++;
      showStory();
    } else if (currentGroupIndex < storyGroups.length - 1) {
      currentGroupIndex++;
      currentStoryIndex = 0;
      showStory();
    } else {
      closeViewer();
    }
  }

  function prevStory() {
    const group = storyGroups[currentGroupIndex];
    if (!group) return;

    if (currentStoryIndex > 0) {
      currentStoryIndex--;
      showStory();
    } else if (currentGroupIndex > 0) {
      currentGroupIndex--;
      const prevGroup = storyGroups[currentGroupIndex];
      currentStoryIndex = prevGroup.media.length - 1;
      showStory();
    }
  }

  function openStoryGroup(groupIndex, storyIndex = 0) {
    currentGroupIndex = groupIndex;
    currentStoryIndex = storyIndex;
    showStory();
  }

  // ---------- OUVERTURE DU CHAT ----------
  function openChatForCharacter(characterName, initialMessage) {
    startChat(characterName);

    setTimeout(() => {
      if (initialMessage) {
        const input = document.getElementById('user-input');
        if (input) {
          input.value = initialMessage;
          input.focus();
        }
      }
    }, 300);
  }

  // ---------- RENDU DES VIGNETTES ----------
  function renderStoryThumbnails(container) {
    container.innerHTML = '';
    storyGroups.forEach((group, groupIndex) => {
      const thumbUrl = group.media[0];
      const item = document.createElement('div');
      item.className = 'story-item';

      let thumbNode;
      if (/\.(mp4|webm|mov)$/i.test(thumbUrl)) {
        thumbNode = document.createElement('video');
        thumbNode.src = thumbUrl;
        thumbNode.autoplay = true;
        thumbNode.loop = true;
        thumbNode.muted = true;
        thumbNode.playsInline = true;
      } else {
        thumbNode = document.createElement('img');
        thumbNode.src = thumbUrl;
      }
      thumbNode.className = 'story-thumb';

      const label = document.createElement('div');
      label.className = 'story-name';
      label.textContent = group.characterName;

      item.appendChild(thumbNode);
      item.appendChild(label);

      item.addEventListener('click', () => {
        openStoryGroup(groupIndex, 0);
      });

      container.appendChild(item);
    });
  }

  // ---------- LOAD STORIES (avec cache 24h + filtre format) ----------
  async function loadStories() {
    await waitForCharacters();

    const container = document.getElementById('stories');
    if (!container) return;

    // 1) Tentative de r√©cup√©ration du cache
    const cachedRaw = localStorage.getItem(STORY_CACHE_KEY);
    if (cachedRaw) {
      try {
        const cached = JSON.parse(cachedRaw);
        if (cached.timestamp && Date.now() - cached.timestamp < STORY_CACHE_TTL_MS && Array.isArray(cached.groups)) {
          storyGroups = cached.groups;
          renderStoryThumbnails(container);
          return;
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è Cache stories invalide, on le recr√©e.');
      }
    }

    // 2) Pas de cache valide ‚Üí on reconstruit
    storyGroups = [];

    // si tu veux toutes les IA : const maxStories = characters.length;
    const maxStories = characters.length;
    const subset = characters.slice(0, maxStories);

    for (const char of subset) {
      const folder = getCharacterStoryFolder(char);
      if (!folder) continue;

      try {
        const res = await fetch(
          `/api/story-media?folder=${encodeURIComponent(folder)}`
        );
        const data = await res.json();
        if (!resolvedMedia || !resolvedMedia.length) continue;

        // üî• On ne garde que les m√©dias au vrai format "story" (vertical)
        const filteredMedia = await filterStoryMediaList(resolvedMedia);
        if (!filteredMedia.length) continue;

        // ‚úÖ Avatar image only
        let avatarUrl = resolveStoryMedia(char.photo);

if (avatarUrl && /\.(mp4|webm|mov)$/i.test(avatarUrl)) {
  avatarUrl = resolveStoryMedia(char.backgroundPhoto) || filteredMedia[0];
}


        storyGroups.push({
          characterName: char.name,
          avatar: avatarUrl,
          media: filteredMedia,
        });
      } catch (err) {
        console.error('‚ùå Erreur story pour', char.name, err);
      }
    }

    // Sauvegarde cache 24h
    try {
      localStorage.setItem(
        STORY_CACHE_KEY,
        JSON.stringify({
          timestamp: Date.now(),
          groups: storyGroups,
        })
      );
    } catch (e) {
      console.warn('‚ö†Ô∏è Impossible de cacher les stories :', e);
    }

    renderStoryThumbnails(container);
  }

  // ---------- LISTENERS ----------
  document.addEventListener('DOMContentLoaded', () => {
    loadStories();

    document
      .getElementById('story-close-btn')
      .addEventListener('click', closeViewer);

    document
      .getElementById('story-prev')
      .addEventListener('click', (e) => {
        e.stopPropagation();
        prevStory();
      });

    document
      .getElementById('story-next')
      .addEventListener('click', (e) => {
        e.stopPropagation();
        nextStory();
      });

    // clic fond noir = fermer
    document
      .getElementById('story-viewer')
      .addEventListener('click', (e) => {
        if (e.target.id === 'story-viewer') closeViewer();
      });

    // Envoi r√©ponse
    const replyInput = document.getElementById('story-reply-input');
    const replyBtn = document.getElementById('story-reply-send');

    function sendReply() {
      const msg = replyInput.value.trim();
      const group = storyGroups[currentGroupIndex];
      if (!group || !msg) return;
      closeViewer();
      openChatForCharacter(group.characterName, msg);
      replyInput.value = '';
    }

    replyBtn.addEventListener('click', sendReply);
    replyInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendReply();
      }
    });
  });
</script>






    </body>
    </html>
